name: Deploy Portfolio

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # Step 1: Checkout the repository
      # This step checks out the repository code to the runner
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2a: Set up Node.js environment
      # This step sets up the Node.js environment with the specified version
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      # Step 2b: Install dependencies
      # This step installs the project dependencies defined in package.json
      - name: Install dependencies
        run: npm install

      # Step 3a: HTML Validation
      # This step validates HTML files using the tidy tool
      - name: Validate HTML
        run: npm run validate:html

      # Step 3b: CSS Validation
      # This step validates CSS files using stylelint
      - name: Validate CSS
        run: npm run lint:css

      # Step 3c: JavaScript Linting
      # This step lints JavaScript files using eslint
      - name: Lint JavaScript
        run: npm run lint:js

      # Step 4: Create automated PR for deployment
      # This step creates a pull request for deployment using the create-pull-request action
      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: deploy-changes
          base: main
          title: Deploy updates
          body: "This PR contains the latest updates for deployment."
          commit-message: "Deploy updates ðŸš€"

      # Step 5: Enable Auto-merge
      # This step enables auto-merge for the created pull request using GitHub CLI
      - name: Enable Auto-merge
        if: steps.create-pr.outputs.pull-request-number
        run: |
          gh pr merge --auto --merge "${{ steps.create-pr.outputs.pull-request-number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}"